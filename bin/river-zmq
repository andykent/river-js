#!/usr/bin/env coffee

process.title = 'river'

river = require('./../lib/river')

try
  zmq = require('zmq')
catch e
  console.log("MISSING zmq LIB! Please `brew install zeromq` and `npm install -g zmq`")
  process.exit(1)



url = process.argv[2]
query = process.argv[3]
mode = process.argv[4] || 'i'

ctx = river.createContext()

console.log("*** Registering Query ***")

q = ctx.addQuery(query)

if mode is 'i'
  q.on 'insert', (v) -> console.log(JSON.stringify(v))

if mode is 'r'
  q.on 'remove', (v) -> console.log(JSON.stringify(v))

if mode is 'ir'
  q.on 'insert', (v) -> console.log("+ | #{JSON.stringify(v)}")
  q.on 'remove', (v) -> console.log("- | #{JSON.stringify(v)}")

console.log(q.toString())

console.log("*** Connecting to: #{url} ***")

socket = zmq.createSocket('sub')
socket.connect(url)
socket.subscribe('')


socket.on 'message', (ch, data) ->
  msg = JSON.parse(data.toString('utf8'))
  # bit of a hack to change streams to use underscores instead of dashes as they aren't valid sql tables names
  table = ch.toString('utf8').replace(/\-/g, '_')
  ctx.push(table, msg)